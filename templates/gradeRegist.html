<!DOCTYPE html>
<html>
	<head>
		<title>学年設定</title>
		<meta http-equiv="content-type" content="text/html; charset=UTF-8">
		<meta name="robots" content="noindex, nofollow">
		<meta name="googlebot" content="noindex, nofollow">
		{literal}
			<script type="text/javascript" src="{/literal}{$smarty.const.HOME_DIR}{literal}js/jquery.min.js"></script>
			<script type="text/javascript" src="{/literal}{$smarty.const.HOME_DIR}{literal}js/jquery-ui.js"></script>
			<script type="text/javascript" src="{/literal}{$smarty.const.HOME_DIR}{literal}js/common.js"></script>
		{/literal}
		<link href="{$smarty.const.HOME_DIR}css/jquery-ui.css" rel="stylesheet">
		<link href="{$smarty.const.HOME_DIR}css/default.css" rel="stylesheet">

		<script type="text/javascript">
			// エンターキー押下時のsubmitを無効化
			$(document).on("keypress", "input:not(.allow_submit)", function(event) {
				return event.which !== 13;
			});
			// エンターキー押下時のsubmitを無効化
			$(document).on("keypress", "select:not(.allow_submit)", function(event) {
				return event.which !== 13;
			});
			//表示再現
			$(document).ready(function() {

				$(function() {
					$('#start_period').datepicker({
						showOn : "button",
						buttonImage : "{$smarty.const.HOME_DIR}image/calendar.svg",
						dateFormat: 'yy/mm/dd',
						buttonImageOnly : true,
						beforeShow: function (input, inst) {
							setTimeout(function () {
							    var leftWidth=($('.pushmenu-open').length>0)?$('#start_period').offset().left-$('.pushmenu-open')[0].offsetWidth
	                                    :$('#start_period').offset().left;
								inst.dpDiv.css({
									top: $('#start_period').offset().top + 35,
									left: leftWidth
								});
							}, 0);
						}
					});
				});

				$(function() {
					$('#end_period').datepicker({
						showOn : "button",
						buttonImage : "{$smarty.const.HOME_DIR}image/calendar.svg",
						dateFormat: 'yy/mm/dd',
						buttonImageOnly : true,
						beforeShow: function (input, inst) {
							setTimeout(function () {
							    var leftWidth=($('.pushmenu-open').length>0)?$('#end_period').offset().left-$('.pushmenu-open')[0].offsetWidth
	                                    :$('#end_period').offset().left;
								inst.dpDiv.css({
									top: $('#end_period').offset().top + 35,
									left: leftWidth
								});
							}, 0);
						}
					});
				});

				// MSGのあるなし
				if ( $(".error_msg").html() != "" ){

					$(".error_section").slideToggle('slow')
				}

				$(".close_icon").on('click', function(){

					$(".error_section").slideToggle('slow')
					$('#err_dis').slideToggle('slow')
				});

				/* ラジオボタンのチェック変更イベント */
				$('#main_form input').on('change', function() {

					var status_val = $('input[name=chk_status]:checked', '#main_form').val();
					$("#status").val(status_val);
					$("#answer_flg").val(status_val);
				});
			});
		</script>
	</head>
	<body class="pushmenu-push">
		<form id="main_form" action="{$smarty.const.HOME_DIR}GradeRegist/save" method="post">
			<input type="hidden" id="admin_no" name="admin_no"/>
			<input type="hidden" id="org_no" name="org_no" value="{$form->org_no}"/>
			<input type="hidden" id="page" name="page" value="{$form->page}" />
			<input type="hidden" id="grade_no" name="grade_no" value="{$form->grade_no}" />
			<input type="hidden" id="screen_mode" name="screen_mode" value="{$form->screen_mode}">
			<input type="hidden" id="search_page" name="search_page" value="{$form->search_page}"/>
			<input type="hidden" id="search_start_period" name="search_start_period" value="{$form->search_start_period}"/>
			<input type="hidden" id="search_end_period" name="search_end_period" value="{$form->search_end_period}"/>
			<input type="hidden" id="search_org_name" name="search_org_name" value="{$form->search_org_name}"/>
			<input type="hidden" id="search_chk_status" name="search_chk_status" value="{$form->search_chk_status}"/>
			<input type="hidden" id="search_chk_status1" name="search_chk_status1" value="{$form->search_chk_status1}"/>
			<input type="hidden" id="search_chk_status2" name="search_chk_status2" value="{$form->search_chk_status2}"/>
			<input type="hidden" id="search_chk_status3" name="search_chk_status3" value="{$form->search_chk_status3}"/>
			<input type="hidden" id="btn_flag" name="btn_flag" value="{$form->btn_flag}"/>
			<input type="hidden" id="organization_no" name="organization_no" value="{$form->organization_no}">
			<input type="hidden" id="organization_id" name="organization_id" value="{$form->organization_id}">
			<input type="hidden" id="organization_name" name="organization_name" value="{$form->organization_name|escape}">
			<input type="hidden" id="organization_name_kana" name="organization_name_kana" value="{$form->organization_name_kana|escape}"/>
			<input type="hidden" id="organization_official" name="organization_official" value="{$form->organization_official|escape}"/>
			<input type="hidden" id="organization_kbn" name="organization_kbn" value="{$form->organization_kbn}"/>
			<input type="hidden" id="organization_type" name="organization_type" value="{$form->organization_type}"/>
			<input type="hidden" id="org_function_type" name="org_function_type" value="{$form->org_function_type}"/>
			<input type="hidden" id="organization_start_date" name="organization_start_date" value="{$form->organization_start_date}"/>
			<input type="hidden" id="org_start_period" name="org_start_period" value="{$form->org_start_period}"/>
			<input type="hidden" id="org_end_period" name="org_end_period" value="{$form->org_end_period}"/>
			<input type="hidden" id="contract_start_date" name="contract_start_date" value="{$form->contract_start_date}"/>
			<input type="hidden" id="contract_end_date" name="contract_end_date" value="{$form->contract_end_date}"/>
			<input type="hidden" id="organization_admin" name="organization_admin" value="{$form->organization_admin}"/>
			<input type="hidden" id="org_phone_no" name="org_phone_no" value="{$form->org_phone_no}"/>
			<input type="hidden" id="organization_mail" name="organization_mail" value="{$form->organization_mail}"/>
			<input type="hidden" id="org_contract_no" name="org_contract_no" value="{$form->org_contract_no}"/>
			<input type="hidden" id="org_manager_nm" name="org_manager_nm" value="{$form->org_manager_nm}"/>
			<input type="hidden" id="org_remarks" name="org_remarks" value="{$form->org_remarks|escape}"/>
			<input type="hidden" id="screen_value" name="screen_value" value="{$form->screen_value}" />
			<input type="hidden" id="grade_cnt" value="{$grade_cnt}" />
			<input type="hidden" id="initial_disp_no" value="{$form->disp_no}">
			{include file='leftMenu.html'}
			<div class="divHeader">
				<!--header-->
					{include file='header.html'}
				<!--header-->
			</div>
			<div class="divBody">
				<div id="err_dis" tabindex="1">
					<section class="error_section">
						<img src="{$smarty.const.HOME_DIR}image/close_icon.png" style="width:15px;float:right" class="close_icon">
						{if !empty($error_msg)}
							<div class="error_msg">{$error_msg}</div>
						{else if !empty($info_msg)}
							<div class="error_msg">{$info_msg}</div>
						{else}
							<div class="error_msg"></div>
						{/if}
					</section>
				</div>
				<section class="content">
					<p>
						><span class="title">組織登録 / 組織学年設定</span>
					</p>
					<p style="text-align:right;width:100%;">
						<input type="button" title="戻る" value="" class="btn_back" onclick="javascript:doBack('{$smarty.const.HOME_DIR}GradeRegist/back')">
					</p>
					<table style="width: 50%; margin-top: -30px;">
						<tr>
							<td></td>
							<td></td>
							<td></td>
							<td><label>{$org_name|escape}</label></td>
						</tr>
						<tr>
							<td>組織ID</td>
							<td><label>{$org_id}</label></td>
							<td>組織名</td>
							<td><label>{$org_name_kana|escape}</label></td>
						</tr>
						<tr>
							<td></td>
							<td></td>
							<td></td>
							<td><label>{$org_name_official|escape}</label></td>
						</tr>
					</table>
					<br>
					<table class="main_tbl">
						<tr>
							<td>学年名<span class="required">※</span></td>
							<td class="input">
								<input class="text" type="text" name="grade_name" id="grade_name" value="{$form->grade_name|escape}" maxlength = "32" size="30">
							</td>
							<td class="st_col">学年名ふりがな<span class="required">※</span></td>
							<td><input class="text" type="text" name="grade_name_kana" id="grade_name_kana" value="{$form->grade_name_kana|escape}" maxlength = "32" size="30"></td>
						</tr>
						<tr>
							<td>表示順<span class="required">※</span></td>
							<td class="input">
								<input class="text" type="text" name="disp_no" id="disp_no" value="{$form->disp_no}" maxlength = "3" size="30">
							</td>
							<td></td>
							<td></td>
						</tr>
						<tr>
							<td class="st_col">利用開始日<span class="required">※</span></td>
							<td class="input" style="width:250px;"><input class="" type="text" name="start_period" id="start_period"
									value="{$form->start_period}" maxlength="10" onchange="changeDateFormat(this)"></td>
							<td class="st_col">利用終了日<span class="required">※</span></td>
							<td class="input"><input class="" type="text" name="end_period" id="end_period"
							 value="{$form->end_period}" maxlength="10" onchange="changeDateFormat(this)"></td>
						</tr>
						<tr>
							<td class="st_col">備考<span class="required">※</span></td>
							<td class="st_col" colspan="2"><input class="text" type="text" name="remarks" id="remarks" value="{$form->remarks|escape}" maxlength = "512" size="30" style="width: 100%;"></td>
							<td></td>
						</tr>
					</table>
					<p style="text-align:right;">
						<input type="submit" name="btn_insert" title="登録" value="" class="btn_insert"  style="padding-right: 50px;">
						<input type="button" title="キャンセル" value="" class="btn_close" onclick="javascript:doClear()"  id="cancel" style="display:none">
					</p>
					<table class="tbl_search">
						<thead>
							<tr>
								<th width="150px">学年名</th>
								<th width="150px">学年名ふりがな</th>
								<th width="70px">表示順</th>
								<th width="200px">利用期間</th>
								<th width="200px">備考</th>
								<th class="td_img">編集</th>
								<th class="td_img">削除</th>
							</tr>
						</thead>
						<tbody>
						{if !empty($list)}
							{foreach $list as $result}
							<tr>
								<td width="150px">{$result->grade_name|escape}</td>
								<td width="150px">{$result->grade_name_kana|escape}</td>
								<td width="70px">{$result->disp_no}</td>
								<td width="200px">{$result->start_period}～{$result->end_period}</td>
								<td width="200px">{$result->remarks|escape}</td>
								<td width="td_img">
									<input type="button" class="btn_edit" title="編集" onclick="edit_trans('{$result->grade_no}','{$smarty.const.HOME_DIR}GradeRegist/index')">
								</td>
								<td class="td_edit">
									<input type="button" class="btn_delete" title="削除" name="delete" onclick="del_trans('{$result->grade_no}','{$smarty.const.HOME_DIR}GradeRegist/delete')">
								</td>
							</tr>
							{/foreach}
						{/if }
						</tbody>
					</table>
				</section>
			</div>
			<!--footer-->
				{include file='footer.html'}
			<!--footer-->
		</form>

		<script>
			{literal}

			var arr = [];
			{/literal}{foreach $list as $value}{literal}
				arr.push(JSON.parse('{/literal}{json_encode($value)}{literal}'));
			{/literal}{/foreach}{literal}
			// 配列のインデックス
			var no = 0;

			/**
			*
			*  検索ボタン押下、必須チェック処理
			*
			**/
			$(".btn_insert").on('click', function(){

				$("#page").val(1);
				$(".error_section").hide();

				var start_period = document.getElementById('start_period').value;
				var end_period = document.getElementById('end_period').value;
				var grade_name = document.getElementById('grade_name').value;
				var grade_name_kana = document.getElementById('grade_name_kana').value;
				var disp_no = document.getElementById('disp_no').value;
				var remarks = document.getElementById('remarks').value;
				var grade_no = document.getElementById('grade_no').value;
				var initial_disp_no = document.getElementById('initial_disp_no').value;

				// 学年名の必須チェック
				if ( grade_name == "" ){

					$('#err_dis').show();
					$(".error_section").slideToggle('slow');
					$(".error_msg").html("学年名を入力してください。");
					$('#err_dis')[0].focus();
					return false;
				}

				// 学年名ふりがなの必須チェック
				if ( grade_name_kana == "" ){

					$('#err_dis').show();
					$(".error_section").slideToggle('slow');
					$(".error_msg").html("学年名ふりがなを入力してください。");
					$('#err_dis')[0].focus();
					return false;
				}

				// 表示順の必須チェック
				if ( disp_no == "" ){

					$('#err_dis').show();
					$(".error_section").slideToggle('slow');
					$(".error_msg").html("表示順を入力してください。");
					$('#err_dis')[0].focus();
					return false;
				}

				for (  no = 0; no < $("#grade_cnt").val(); no++ ) {
					if ( initial_disp_no != disp_no && disp_no == arr[no].disp_no ){

						$('#err_dis').show();
						$(".error_section").slideToggle('slow');
						$(".error_msg").html("表示順が重複しています。");
						$('#err_dis')[0].focus();
						return false;
					}
				}

				// 表示順は整数かどうかチェック
				if ( isNaN(disp_no) ){

					$('#err_dis').show();
					$(".error_section").slideToggle('slow');
					$(".error_msg").html("表示順を数字で入力してください。");
					$('#err_dis')[0].focus();
					return false;
				}

				// 利用開始日の必須チェック
				if ( start_period == "" ){

					$('#err_dis').show();
					$(".error_section").slideToggle('slow');
					$(".error_msg").html("利用開始日を入力してください。");
					$('#err_dis')[0].focus();
					return false;
				}

				// 利用終了日の必須チェック
				if ( end_period == "" ){

					$('#err_dis').show();
					$(".error_section").slideToggle('slow');
					$(".error_msg").html("利用終了日を入力してください。");
					$('#err_dis')[0].focus();
					return false;
				}

				// 利用開始日 < 利用終了日チェック
				if ( start_period > end_period ){

					$('#err_dis').show();
					$(".error_section").slideToggle('slow');
					$(".error_msg").html("{/literal}{$smarty.const.W004}{literal}");
					$('#err_dis')[0].focus();
					return false;
				}

				// 備考の必須チェック
				if ( remarks == "" ){

					$('#err_dis').show();
					$(".error_section").slideToggle('slow');
					$(".error_msg").html("備考を入力してください。");
					$('#err_dis')[0].focus();
					return false;
				}
				return true;
			});

			// ページング
			function doPage(pageNo){

				$("#page").val(pageNo);
				$("#main_form").submit();
			}

			// 編集ボタン処理
			function edit_trans(grade_no ,action){

				var menuOpen = document.getElementById('menuOpen').value;
				var menuStatus = document.getElementById('menuStatus').value;

				$("#main_form").attr("action", action);
				$("#menuOpen").val(menuOpen);
				$("#menuStatus").val(menuStatus);
				$("#grade_no").val(grade_no);

				setSearchFormData();
			}

			// 削除ボタン処理
			function del_trans(grade_no,action){

				var result = confirm("削除します。よろしいでしょうか。");

				if ( result ){

					//はいを選んだときの処理
					var menuOpen = document.getElementById('menuOpen').value;
					var menuStatus = document.getElementById('menuStatus').value

					$("#main_form").attr("action", action);
					$("#menuOpen").val(menuOpen);
					$("#menuStatus").val(menuStatus);
					$("#grade_no").val(grade_no);

					$("#main_form").submit();
				}else {
				 //いいえを選んだときの処理
				}
			}

			// キャンセルボタン処理
			function doClear(){

				$("#grade_no").val("");
				$("#grade_name").val("");
				$("#grade_name_kana").val("");
				$("#disp_no").val("");
				$("#remarks").val("");
				$("#start_period").val("");
				$("#end_period").val("");
			}

			// 戻るボタン処理
			function doBack(action){

				$("#main_form").attr("action", action);
				$("#main_form").submit();
			}

			/**
			**  検索条件セットとフォーム
			**/
			function setSearchFormData() {

				var menuOpen = document.getElementById('menuOpen').value;
				var menuStatus = document.getElementById('menuStatus').value;

				$("#menuOpen").val(menuOpen);
				$("#menuStatus").val(menuStatus);
				$("#search_page").val($("#search_page").val());
				$("#search_start_period").val($("#search_start_period").val());
				$("#search_end_period").val($("#search_end_period").val());
				$("#search_org_name").val($("#search_org_name").val());
				$("#search_chk_status").val($("#search_chk_status").val());

				$("#search_chk_status1").val("");
				if ( $("#chk_status1").prop('checked') ){
					$("#search_chk_status1").val(1);
				}

				$("#search_chk_status2").val("");
				if ( $("#chk_status2").prop('checked') ){
					$("#search_chk_status2").val(1);
				}

				$("#search_chk_status3").val("");
				if ( $("#chk_status3").prop('checked') ){
					$("#search_chk_status3").val(1);
				}
				$("#main_form").submit();
			}
			window.onload = function init() {

				var grade_no = document.getElementById('grade_no').value;
				if ( grade_no != "" ){

					$("#cancel").css("display","none");
				}else {

					$("#cancel").css("display","");
				}
			}
		{/literal}
	</script>
	</body>
</html>